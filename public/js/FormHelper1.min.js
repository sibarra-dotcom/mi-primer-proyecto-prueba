class FormHelper {
    static toDate() {
        document.addEventListener("DOMContentLoaded", () => {
            const inputs = document.querySelectorAll(".to-date");

            inputs.forEach((input) => {
                const format = FormHelper.detectFormatFromPlaceholder(input);
                FormHelper.handleDateInput(input, format);
            });
        });
    }

    // Detect the format (dd-mm-yyyy or mm-dd-yyyy) from the input's placeholder
    static detectFormatFromPlaceholder(inputElement) {
        const placeholder = inputElement.getAttribute("placeholder") || "";
        
        // Check for dd-mm-yyyy or mm-dd-yyyy patterns
        if (placeholder.includes("dd") && placeholder.includes("mm") && placeholder.includes("yyyy")) {
            return "dd-mm-yyyy";
        } else if (placeholder.includes("mm") && placeholder.includes("dd") && placeholder.includes("yyyy")) {
            return "mm-dd-yyyy";
        } else {
            return "dd-mm-yyyy"; // Default fallback if the placeholder format is unknown
        }
    }

    static handleDateInput(inputElement, format) {
        // Create hidden input
        const hiddenInput = document.createElement("input");
        hiddenInput.type = "hidden";
        hiddenInput.name = inputElement.getAttribute("data-name");
        inputElement.parentElement.appendChild(hiddenInput);

        // Precompute format indexes
        const parts = format.split("-");        // e.g. ["dd","mm","yyyy"]
        const pos = {
            day: parts.indexOf("dd"),
            month: parts.indexOf("mm"),
            year: parts.indexOf("yyyy"),
        };

        inputElement.addEventListener("input", (e) => {
            let val = e.target.value.replace(/\D/g, ""); // only numbers

            // Max length (ddmmyyyy â†’ 8 digits)
            if (val.length > 8) val = val.substring(0, 8);

            // Insert dashes dynamically based on chosen format positions
            val = FormHelper.insertDashes(val, parts);

            inputElement.value = val;

            // Validate format fully entered
            const regex = FormHelper.buildRegex(format);
            if (!regex.test(val)) {
                hiddenInput.value = "";
                return;
            }

            // Extract parts based on chosen format positions
            const chunks = val.split("-");
            const day = chunks[pos.day];
            const month = chunks[pos.month];
            const year = chunks[pos.year];

            if (FormHelper.isValidDate(day, month, year)) {
                hiddenInput.value = `${year}-${month}-${day}`; // normalized
            } else {
                hiddenInput.value = "";
            }
        });
    }

    // Insert "-" according to format structure
    static insertDashes(value, parts) {
        let result = value;

        if (value.length >= 3) {
            result = value.replace(
                /(\d{2})(\d{1,2})/,
                (m, g1, g2) =>
                    parts[0].length === 4
                        ? `${g1}-${g2}`       // yyyy-mm-dd type
                        : `${g1}-${g2}`
            );
        }

        if (value.length >= 6) {
            result = result.replace(
                /(\d{2})-(\d{2})(\d{1,4})/,
                "$1-$2-$3"
            );
        }

        return result;
    }

    // Build regex dynamically for any format (dd-mm-yyyy, mm-dd-yyyy)
    static buildRegex(format) {
        let r = format;
        r = r.replace("dd", "\\d{2}");
        r = r.replace("mm", "\\d{2}");
        r = r.replace("yyyy", "\\d{4}");
        return new RegExp("^" + r + "$");
    }

    // Validate date using actual calendar
    static isValidDate(day, month, year) {
        const d = parseInt(day);
        const m = parseInt(month);
        const y = parseInt(year);

        if (isNaN(d) || isNaN(m) || isNaN(y)) return false;
        if (m < 1 || m > 12) return false;

        const daysInMonth = new Date(y, m, 0).getDate();
        return d >= 1 && d <= daysInMonth;
    }
}
