class FormHelper {
    static init() {
        document.addEventListener("DOMContentLoaded", () => {
            FormHelper.toDate();
            FormHelper.toTime();
        });
    }

    /* =======================
       DATE HANDLING
    ======================= */

    static toDate() {
        document.addEventListener("DOMContentLoaded", () => {
            const inputs = document.querySelectorAll(".to-date");

            inputs.forEach((input) => {
                const format = FormHelper.detectFormatFromPlaceholder(input);
                FormHelper.handleDateInput(input, format);
            });
        });
    }

    static detectFormatFromPlaceholder(inputElement) {
        const placeholder = inputElement.getAttribute("placeholder") || "";

        if (placeholder.includes("dd") && placeholder.includes("mm") && placeholder.includes("yyyy")) {
            return "dd-mm-yyyy";
        } else if (placeholder.includes("mm") && placeholder.includes("dd") && placeholder.includes("yyyy")) {
            return "mm-dd-yyyy";
        }
        return "dd-mm-yyyy";
    }

    static handleDateInput(inputElement, format) {
        const hiddenInput = document.createElement("input");
        hiddenInput.type = "hidden";
        hiddenInput.name = inputElement.getAttribute("data-name");
        inputElement.parentElement.appendChild(hiddenInput);

        const parts = format.split("-");
        const pos = {
            day: parts.indexOf("dd"),
            month: parts.indexOf("mm"),
            year: parts.indexOf("yyyy"),
        };

        inputElement.addEventListener("input", (e) => {
            let val = e.target.value.replace(/\D/g, "");

            if (val.length > 8) val = val.substring(0, 8);

            val = FormHelper.insertDashes(val);
            inputElement.value = val;

            const regex = FormHelper.buildRegex(format);
            if (!regex.test(val)) {
                hiddenInput.value = "";
                return;
            }

            const chunks = val.split("-");
            const day = chunks[pos.day];
            const month = chunks[pos.month];
            const year = chunks[pos.year];

            if (FormHelper.isValidDate(day, month, year)) {
                hiddenInput.value = `${year}-${month}-${day}`;
								inputElement.classList.remove("ring-2", "ring-red");
								inputElement.setCustomValidity("");
            } else {
                hiddenInput.value = "";
								inputElement.classList.add("ring-2", "ring-red");
								inputElement.setCustomValidity("Fecha no válida");
            }
        });
    }

    static insertDashes(value) {
        let result = value;

        if (value.length >= 3) {
            result = value.replace(/(\d{2})(\d+)/, "$1-$2");
        }
        if (value.length >= 6) {
            result = result.replace(/(\d{2})-(\d{2})(\d+)/, "$1-$2-$3");
        }
        return result;
    }

    static buildRegex(format) {
        let r = format;
        r = r.replace("dd", "\\d{2}");
        r = r.replace("mm", "\\d{2}");
        r = r.replace("yyyy", "\\d{4}");
        return new RegExp("^" + r + "$");
    }

    static isValidDate(day, month, year) {
        const d = +day, m = +month, y = +year;
        if (m < 1 || m > 12) return false;
        const max = new Date(y, m, 0).getDate();
        return d >= 1 && d <= max;
    }

    /* =======================
       TIME HANDLING
    ======================= */

    static toTime() {
				document.addEventListener("DOMContentLoaded", () => {
						const inputs = document.querySelectorAll(".to-time");

						inputs.forEach((input) => {
								const format = FormHelper.detectTimeFormatFromPlaceholder(input);
								FormHelper.handleTimeInput(input, format);
						});
				});
    }

    static detectTimeFormatFromPlaceholder(inputElement) {
        const placeholder = inputElement.getAttribute("placeholder") || "";

        if (placeholder.includes("HH") && placeholder.includes("mm") && placeholder.includes("ss")) {
            return "HH:mm:ss";
        }
        return "HH:mm";
    }

    static handleTimeInput(inputElement, format) {
        const hiddenInput = document.createElement("input");
        hiddenInput.type = "hidden";
        hiddenInput.name = inputElement.getAttribute("data-name");
        inputElement.parentElement.appendChild(hiddenInput);

        const maxLength = format === "HH:mm:ss" ? 6 : 4;

				inputElement.addEventListener("input", (e) => {
						let val = e.target.value.replace(/\D/g, "");

						if (val.length > maxLength) {
								val = val.substring(0, maxLength);
						}

						val = FormHelper.insertTimeColons(val);
						inputElement.value = val;

						const regex = FormHelper.buildTimeRegex(format);

						// Not complete yet → no error styling
						if (!regex.test(val)) {
								hiddenInput.value = "";
								inputElement.classList.remove("outline-red");
								return;
						}

						const parts = val.split(":");
						const h = parts[0];
						const m = parts[1];
						const s = parts[2] ?? "00";

						if (FormHelper.isValidTime(h, m, s)) {
								hiddenInput.value = `${h}:${m}:${s}`;
								inputElement.classList.remove("ring-2", "ring-red");
								inputElement.setCustomValidity("");
						} else {
								hiddenInput.value = "";
								inputElement.classList.add("ring-2", "ring-red");
								inputElement.setCustomValidity("Tiempo no válido");
						}
				});
    }

    static insertTimeColons(value) {
        let result = value;

        if (value.length >= 3) {
            result = value.replace(/(\d{2})(\d+)/, "$1:$2");
        }
        if (value.length >= 5) {
            result = result.replace(/(\d{2}):(\d{2})(\d+)/, "$1:$2:$3");
        }
        return result;
    }

    static buildTimeRegex(format) {
        if (format === "HH:mm:ss") {
            return /^\d{2}:\d{2}:\d{2}$/;
        }
        return /^\d{2}:\d{2}$/;
    }

    static isValidTime(h, m, s) {
        h = +h; m = +m; s = +s;
        return (
            h >= 0 && h <= 23 &&
            m >= 0 && m <= 59 &&
            s >= 0 && s <= 59
        );
    }
}
